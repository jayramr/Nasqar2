FROM condaforge/mambaforge:24.3.0-0

# Set non-interactive frontend and configure timezone
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Dubai

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    tzdata \
    nginx \
    supervisor \
    wget \
    curl \
    git \
    && ln -fs /usr/share/zoneinfo/$TZ /etc/localtime \
    && dpkg-reconfigure --frontend noninteractive tzdata \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# --- Create dedicated user: nasqar ---
RUN useradd -m -s /bin/bash nasqar

# Give ownership of common dirs to nasqar
RUN mkdir -p /srv/shiny-server /usr/share/nginx/html /var/log/nasqar \
    && chown -R nasqar:nasqar /srv/shiny-server /usr/share/nginx/html /var/log/nasqar

# --- Copy environment.yaml first to leverage Docker cache ---
COPY environment.yaml /srv/shiny-server/environment.yaml

# Create the conda environment as root
RUN mamba env create -f /srv/shiny-server/environment.yaml

# Set PATH to include conda env
ENV PATH=/opt/conda/envs/merged_env/bin:$PATH

# Install R packages in merged_env
RUN conda run -n merged_env R -e "\
  install.packages(c('smplot2','GOplot','wordcloud2','Seurat'), repos='http://cran.rstudio.com/'); \
  remotes::install_github('bnprks/BPCells/r'); \
  devtools::install_github('mahmoudibrahim/genesorteR'); \
  remotes::install_github('satijalab/seurat-wrappers'); \
  remotes::install_github('daqana/dqshiny')"

# Install monocle3
SHELL ["/bin/bash", "-c"]
RUN source activate merged_env && \
    R -e "devtools::install_github('cole-trapnell-lab/monocle3', force = TRUE)"

# Copy BSgenome tarball (you must ADD or COPY before this step!)
COPY BSgenome.Hsapiens.UCSC.hg19_1.4.3.tar.gz /
RUN conda run -n merged_env R CMD INSTALL /BSgenome.Hsapiens.UCSC.hg19_1.4.3.tar.gz

# Clean conda cache
RUN mamba clean -a -y

# Copy application directories
COPY animalcules /srv/shiny-server/animalcules
COPY ATACseqQCShniy /srv/shiny-server/ATACseqQCShniy
COPY ClusterProfShinyGSEA /srv/shiny-server/ClusterProfShinyGSEA
COPY ClusterProfShinyORA /srv/shiny-server/ClusterProfShinyORA
COPY dada2Shiny /srv/shiny-server/dada2Shiny
COPY deseq2shiny /srv/shiny-server/deseq2shiny
COPY DEBrowser /srv/shiny-server/DEBrowser
COPY GeneCountMerger /srv/shiny-server/GeneCountMerger
COPY monocle3 /srv/shiny-server/monocle3
COPY SeuratV5Shiny /srv/shiny-server/SeuratV5Shiny
COPY mergeFPKMs /srv/shiny-server/mergeFPKMs
COPY tsar_nasqar /srv/shiny-server/tsar_nasqar

# Copy configuration files
COPY nginx.conf /etc/nginx/nginx.conf
COPY uiApp/src/out/ /usr/share/nginx/html
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Update supervisor config paths
RUN sed -i 's|/opt/conda/envs/v_[^/]*|/opt/conda/envs/merged_env|g' /etc/supervisor/conf.d/supervisord.conf

# --- Switch to nasqar user for runtime ---
USER nasqar
WORKDIR /home/nasqar

# Expose nginx port
EXPOSE 80

# Use supervisor to run multiple services
CMD ["/usr/bin/supervisord"]
